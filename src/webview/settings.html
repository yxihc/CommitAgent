<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Commit Settings</title>
    <style>
        :root {
            --container-paddding: 20px;
            --input-padding-vertical: 6px;
            --input-padding-horizontal: 4px;
            --input-margin-vertical: 4px;
            --input-margin-horizontal: 0;
        }

        body {
            font-family: var(--vscode-font-family);
            padding: var(--container-paddding);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .provider-card {
            border: 1px solid var(--vscode-widget-border);
            background: var(--vscode-editor-background);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            position: relative;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 12px;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: 2px;
            box-sizing: border-box;
        }

        input:focus, select:focus, textarea:focus {
            outline: 1px solid var(--vscode-focusBorder);
        }

        button {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 2px;
            font-size: 13px;
        }

        button:hover {
            background: var(--vscode-button-hoverBackground);
        }

        button.secondary {
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }

        button.secondary:hover {
            background: var(--vscode-button-secondaryHoverBackground);
        }

        button.icon-btn {
            background: transparent;
            padding: 4px;
            color: var(--vscode-foreground);
        }
        
        button.icon-btn:hover {
            background: var(--vscode-toolbar-hoverBackground);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--vscode-widget-border);
            padding-bottom: 10px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-weight: bold;
            font-size: 14px;
        }

        .actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .models-container {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }
        
        .models-input {
            flex: 1;
        }

        .hidden {
            display: none;
        }
        
        .global-settings {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--vscode-widget-border);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>AI Providers Configuration</h2>
            <button id="add-btn">Add New Provider</button>
        </div>

        <div id="providers-list">
            <!-- Providers will be rendered here -->
        </div>

        <div class="global-settings">
            <h3>Default Settings</h3>
            <div class="form-group">
                <label>Default Provider</label>
                <select id="default-provider-select"></select>
            </div>
            <div class="form-group">
                 <label>Default Model</label>
                 <select id="default-model-select"></select>
            </div>
        </div>

        <div style="margin-top: 30px; text-align: right;">
            <button id="save-btn" style="width: 150px;">Save Settings</button>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        let state = {
            providers: [],
            defaultProviderId: '',
            defaultModel: ''
        };

        // Initialize
        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'config-data':
                    state = message.data;
                    render();
                    break;
                case 'fetch-success':
                    handleFetchSuccess(message.data);
                    break;
                case 'fetch-error':
                    console.error(message.error);
                    break;
            }
        });

        // Request initial data
        vscode.postMessage({ command: 'get-config' });

        function createProvider(id) {
            return {
                id: id || 'provider-' + Date.now(),
                name: 'New Provider',
                type: 'openai-compatible',
                apiKey: '',
                baseUrl: '',
                models: []
            };
        }

        document.getElementById('add-btn').addEventListener('click', () => {
            state.providers.push(createProvider());
            render();
        });

        document.getElementById('save-btn').addEventListener('click', () => {
            // Collect data from DOM to ensure latest edits are captured
            updateStateFromDOM();
            vscode.postMessage({
                command: 'save-config',
                data: state
            });
        });

        document.getElementById('default-provider-select').addEventListener('change', (e) => {
            state.defaultProviderId = e.target.value;
            // Reset default model when provider changes
            const provider = state.providers.find(p => p.id === state.defaultProviderId);
            state.defaultModel = provider && provider.models.length > 0 ? provider.models[0] : '';
            renderDefaultSelectors();
        });

        document.getElementById('default-model-select').addEventListener('change', (e) => {
            state.defaultModel = e.target.value;
        });

        function handleFetchSuccess(data) {
            const index = state.providers.findIndex(p => p.id === data.providerId);
            if (index !== -1) {
                state.providers[index].models = data.models;
                render();
            }
        }

        function updateStateFromDOM() {
            const cards = document.querySelectorAll('.provider-card');
            state.providers = Array.from(cards).map(card => {
                const id = card.dataset.id;
                const modelsStr = card.querySelector('.models-ta').value;
                const models = modelsStr.split(',').map(s => s.trim()).filter(s => s);
                
                return {
                    id: id,
                    name: card.querySelector('.name-input').value,
                    type: card.querySelector('.type-select').value,
                    apiKey: card.querySelector('.key-input').value,
                    baseUrl: card.querySelector('.url-input').value,
                    models: models
                };
            });
            
            state.defaultProviderId = document.getElementById('default-provider-select').value;
            state.defaultModel = document.getElementById('default-model-select').value;
        }

        function render() {
            const list = document.getElementById('providers-list');
            list.innerHTML = '';

            state.providers.forEach((provider, index) => {
                const card = document.createElement('div');
                card.className = 'provider-card';
                card.dataset.id = provider.id;

                card.innerHTML = `
                    <div class="card-header">
                        <span class="card-title">${index + 1}. ${escapeHtml(provider.name)}</span>
                        <div class="actions">
                             <button class="secondary delete-btn">Remove</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" class="name-input" value="${escapeHtml(provider.name)}">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select class="type-select">
                            <option value="openai" ${provider.type === 'openai' ? 'selected' : ''}>OpenAI</option>
                            <option value="openai-compatible" ${provider.type === 'openai-compatible' ? 'selected' : ''}>OpenAI Compatible</option>
                            <option value="deepseek" ${provider.type === 'deepseek' ? 'selected' : ''}>DeepSeek</option>
                            <option value="gemini" ${provider.type === 'gemini' ? 'selected' : ''}>Gemini</option>
                            <option value="claude" ${provider.type === 'claude' ? 'selected' : ''}>Claude</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="password" class="key-input" value="${escapeHtml(provider.apiKey)}">
                    </div>
                    <div class="form-group">
                        <label>Base URL</label>
                        <input type="text" class="url-input" value="${escapeHtml(provider.baseUrl || '')}" placeholder="e.g. https://api.openai.com/v1">
                    </div>
                    <div class="form-group">
                        <label>Models (comma separated)</label>
                        <div class="models-container">
                            <textarea class="models-input models-ta" rows="2">${escapeHtml(provider.models.join(', '))}</textarea>
                            <button class="secondary fetch-btn">Fetch</button>
                        </div>
                    </div>
                `;

                // Add Event Listeners for this card
                card.querySelector('.delete-btn').addEventListener('click', () => {
                    state.providers.splice(index, 1);
                    render();
                });

                card.querySelector('.fetch-btn').addEventListener('click', () => {
                    // Update this provider state first
                    provider.apiKey = card.querySelector('.key-input').value;
                    provider.baseUrl = card.querySelector('.url-input').value;
                    
                    vscode.postMessage({
                        command: 'fetch-models',
                        data: provider
                    });
                });

                list.appendChild(card);
            });

            renderDefaultSelectors();
        }

        function renderDefaultSelectors() {
            const providerSelect = document.getElementById('default-provider-select');
            const modelSelect = document.getElementById('default-model-select');
            
            // Save current selection if possible
            const currentProviderId = state.defaultProviderId;
            const currentModel = state.defaultModel;

            providerSelect.innerHTML = '<option value="">-- Select Provider --</option>';
            state.providers.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                if (p.id === currentProviderId) option.selected = true;
                providerSelect.appendChild(option);
            });

            modelSelect.innerHTML = '<option value="">-- Select Model --</option>';
            const selectedProvider = state.providers.find(p => p.id === providerSelect.value);
            
            if (selectedProvider) {
                selectedProvider.models.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m;
                    option.textContent = m;
                    if (m === currentModel) option.selected = true;
                    modelSelect.appendChild(option);
                });
            }
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
